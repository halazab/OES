{%load bootstrap5%}
{%load static%}
{%bootstrap_css%}
{%bootstrap_javascript%}




{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>{{ exam.title }}</h3>
            <div id="examTimer" class="text-danger fw-bold"></div>
        </div>
        <form method="post" id="examForm">
            {% csrf_token %}
            {% for question in questions %}
                <div class="question-card" data-question="{{ forloop.counter }}" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">
                            Question <span id="currentQuestionNum">{{ forloop.counter }}</span> of {{ questions|length }}
                        </h5>
                        <p class="card-text">{{ question.text }}</p>
                        
                        {% if question.question_type == 'MCQ' %}
                            <div class="options-container">
                                <label class="choice-item w-100">
                                    <input type="radio" name="question_{{ question.id }}" value="{{ question.option_a }}" class="d-none">
                                    <span class="choice-text">A) {{ question.option_a }}</span>
                                </label>
                                <label class="choice-item w-100">
                                    <input type="radio" name="question_{{ question.id }}" value="{{ question.option_b }}" class="d-none">
                                    <span class="choice-text">B) {{ question.option_b }}</span>
                                </label>
                                <label class="choice-item w-100">
                                    <input type="radio" name="question_{{ question.id }}" value="{{ question.option_c }}" class="d-none">
                                    <span class="choice-text">C) {{ question.option_c }}</span>
                                </label>
                                <label class="choice-item w-100">
                                    <input type="radio" name="question_{{ question.id }}" value="{{ question.option_d }}" class="d-none">
                                    <span class="choice-text">D) {{ question.option_d }}</span>
                                </label>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}

            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <button type="button" id="prevBtn" class="btn btn-secondary" onclick="previousQuestion()" disabled>Previous</button>
                    <div class="question-nav">
                        <ul class="pagination mb-0">
                            <!-- Pagination will be generated by JavaScript -->
                        </ul>
                    </div>
                    <button type="button" id="nextBtn" class="btn btn-primary" onclick="nextQuestion()">Next</button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
.choice-item {
    display: block;
    padding: 15px;
    margin: 10px 0;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.choice-item:hover {
    background-color: #f8f9fa;
    border-color: #adb5bd;
}

.choice-item input[type="radio"]:checked + .choice-text {
    font-weight: bold;
}

.choice-item input[type="radio"]:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.choice-item.selected {
    background-color: #e3f2fd;
    border-color: #0d6efd;
}

.options-container {
    margin-top: 20px;
}

.choice-text {
    display: block;
    position: relative;
    padding-left: 35px;
}

.choice-text:before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #adb5bd;
    border-radius: 50%;
    background-color: #fff;
}

.choice-item input[type="radio"]:checked + .choice-text:before {
    background-color: #0d6efd;
    border-color: #0d6efd;
    box-shadow: inset 0 0 0 4px #fff;
}

.pagination {
    display: flex;
    gap: 5px;
}

.pagination .page-item .page-link {
    border-radius: 4px;
    min-width: 35px;
    text-align: center;
}

.pagination .page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>

<script>
    let currentQuestion = 1;
    const totalQuestions = {{ questions|length }};
    let userAnswers = {};

    // Show first question on page load
    document.addEventListener('DOMContentLoaded', function() {
        showQuestion(1);
        generatePagination();
        startTimer({{ exam.duration }} * 60); // Convert minutes to seconds
        
        // Add event listeners to all choice items
        document.querySelectorAll('.choice-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remove selected class from all siblings
                const parent = this.closest('.options-container');
                parent.querySelectorAll('.choice-item').forEach(sibling => {
                    sibling.classList.remove('selected');
                });
                // Add selected class to clicked item
                this.classList.add('selected');
                
                // Store the answer
                const questionId = this.querySelector('input').name;
                const answer = this.querySelector('input').value;
                userAnswers[questionId] = answer;
            });
        });
    });

    function showQuestion(questionNumber) {
        // Hide all questions
        document.querySelectorAll('.question-card').forEach(card => {
            card.style.display = 'none';
        });
        
        // Show current question
        const questionToShow = document.querySelector(`.question-card[data-question="${questionNumber}"]`);
        if (questionToShow) {
            questionToShow.style.display = 'block';
            
            // Restore any previously selected answer
            const questionInputs = questionToShow.querySelectorAll('input[type="radio"]');
            if (questionInputs.length > 0) {
                const questionName = questionInputs[0].name;
                if (userAnswers[questionName]) {
                    const savedAnswer = userAnswers[questionName];
                    const matchingInput = Array.from(questionInputs).find(input => input.value === savedAnswer);
                    if (matchingInput) {
                        matchingInput.checked = true;
                        matchingInput.closest('.choice-item').classList.add('selected');
                    }
                }
            }
        }
        
        // Update navigation buttons
        document.getElementById('prevBtn').disabled = questionNumber === 1;
        const nextBtn = document.getElementById('nextBtn');
        if (questionNumber === totalQuestions) {
            nextBtn.textContent = 'Submit';
            nextBtn.classList.remove('btn-primary');
            nextBtn.classList.add('btn-success');
            nextBtn.onclick = function() { submitExam(); };
        } else {
            nextBtn.textContent = 'Next';
            nextBtn.classList.remove('btn-success');
            nextBtn.classList.add('btn-primary');
            nextBtn.onclick = function() { nextQuestion(); };
        }
    }

    function previousQuestion() {
        if (currentQuestion > 1) {
            currentQuestion--;
            showQuestion(currentQuestion);
            generatePagination();
        }
    }

    function nextQuestion() {
        if (currentQuestion < totalQuestions) {
            currentQuestion++;
            showQuestion(currentQuestion);
            generatePagination();
        }
    }

    function submitExam() {
        if (confirm('Are you sure you want to submit the exam?')) {
            document.getElementById('examForm').submit();
        }
    }

    function startTimer(duration) {
        let timer = duration;
        const timerDisplay = document.getElementById('examTimer');
        
        const countdown = setInterval(() => {
            const minutes = parseInt(timer / 60, 10);
            const seconds = parseInt(timer % 60, 10);
            
            const formattedMinutes = minutes < 10 ? "0" + minutes : minutes;
            const formattedSeconds = seconds < 10 ? "0" + seconds : seconds;
            
            timerDisplay.textContent = `Time Remaining: ${formattedMinutes}:${formattedSeconds}`;
            
            if (--timer < 0) {
                clearInterval(countdown);
                alert('Time is up! Your exam will be submitted automatically.');
                document.getElementById('examForm').submit();
            }
        }, 1000);
    }

    function generatePagination() {
        const paginationContainer = document.querySelector('.pagination');
        paginationContainer.innerHTML = '';
        
        for (let i = 1; i <= totalQuestions; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentQuestion ? 'active' : ''}`;
            li.innerHTML = `
                <button type="button" class="page-link" onclick="goToQuestion(${i})">
                    ${i}
                </button>
            `;
            paginationContainer.appendChild(li);
        }
    }

    function goToQuestion(questionNumber) {
        currentQuestion = questionNumber;
        showQuestion(questionNumber);
        generatePagination();
    }
</script>
{% endblock %}